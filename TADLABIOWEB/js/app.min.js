class TadlaBioStore {
  constructor() {
    this.products = [];
    this.cart = this.loadCart();
    this.filter = "all";
    this.init();
  }
  async init() {
    await this.loadProducts();
    this.renderProducts();
    this.updateCartCount();
    this.setupEventListeners();
  }
  async loadProducts() {
    try {
      const response = await fetch("data/products.json");
      this.products = await response.json();
    } catch (error) {
      console.error("Error loading products:", error);
      this.products = [
        {
          id: 1,
          name: "Extra Virgin Olive Oil",
          slug: "extra-virgin-olive-oil",
          price_mad: 120,
          weight: "500ml",
          short_desc: "Cold-pressed from first harvest olives",
          long_desc:
            "Our premium extra virgin olive oil is cold-pressed from the first harvest of organic olives grown in the Tadla region. This golden-green oil has a fruity aroma and peppery finish, perfect for dressings and finishing dishes.",
          ingredients: ["100% Organic Olives"],
          is_organic: true,
          category: "oil",
          image: "assets/images/olive-oil.png",
        },
      ];
    }
  }
  loadCart() {
    const cart = localStorage.getItem("tadla_bio_cart");
    return cart ? JSON.parse(cart) : [];
  }
  saveCart() {
    localStorage.setItem("tadla_bio_cart", JSON.stringify(this.cart));
    this.updateCartCount();
  }
  clearCart() {
    this.cart = [];
    this.saveCart();
    this.renderCart();
  }
  addToCart(product, quantity = 1) {
    const existingItem = this.cart.find((item) => item.id === product.id);
    if (existingItem) {
      existingItem.quantity += quantity;
    } else {
      this.cart.push({ ...product, quantity: quantity });
    }
    this.saveCart();
    this.renderCart();
    this.showNotification(`${product.name} added to cart`);
  }
  removeFromCart(productId) {
    this.cart = this.cart.filter((item) => item.id !== productId);
    this.saveCart();
    this.renderCart();
  }
  updateQuantity(productId, change) {
    const item = this.cart.find((item) => item.id === productId);
    if (item) {
      item.quantity += change;
      if (item.quantity <= 0) {
        this.removeFromCart(productId);
      } else {
        this.saveCart();
        this.renderCart();
      }
    }
  }
  renderProducts() {
    const grid = document.getElementById("productsGrid");
    if (!grid) return;
    const filteredProducts =
      this.filter === "all"
        ? this.products
        : this.products.filter((product) =>
            this.filter === "organic"
              ? product.is_organic
              : this.filter === "oil"
              ? product.category === "oil"
              : this.filter === "dairy"
              ? product.category === "dairy"
              : true
          );
    grid.innerHTML = filteredProducts
      .map(
        (product) =>
          `<div class="product-card" data-product-id="${
            product.id
          }"><img src="${product.image}" alt="${
            product.name
          }" class="product-image" loading="lazy"><div class="product-info"><h3 class="product-title">${
            product.name
          }</h3><div class="product-price">${this.formatPrice(
            product.price_mad
          )}</div><div class="product-weight">${
            product.weight
          }</div><p class="product-desc">${
            product.short_desc
          }</p><div class="product-actions"><button class="btn-add-cart" onclick="store.addToCart(${this.escapeProduct(
            product
          )})">Add to Cart</button><button class="btn-view-details" onclick="store.showProductDetail(${
            product.id
          })">Details</button></div></div></div>`
      )
      .join("");
  }
  renderCart() {
    const cartContent = document.getElementById("cartContent");
    if (!cartContent) return;
    if (this.cart.length === 0) {
      cartContent.innerHTML = '<p class="empty-cart">Your cart is empty</p>';
      this.updateTotals();
      return;
    }
    cartContent.innerHTML = this.cart
      .map(
        (item) =>
          `<div class="cart-item"><img src="${item.image}" alt="${
            item.name
          }" class="cart-item-image"><div class="cart-item-details"><div class="cart-item-title">${
            item.name
          }</div><div class="cart-item-price">${this.formatPrice(
            item.price_mad
          )}</div><div class="cart-item-actions"><button class="quantity-btn" onclick="store.updateQuantity(${
            item.id
          }, -1)">-</button><span class="cart-item-quantity">${
            item.quantity
          }</span><button class="quantity-btn" onclick="store.updateQuantity(${
            item.id
          }, 1)">+</button><button class="remove-btn" onclick="store.removeFromCart(${
            item.id
          })" aria-label="Remove item">Ã—</button></div></div></div>`
      )
      .join("");
    this.updateTotals();
  }
  updateTotals() {
    const subtotal = this.cart.reduce(
      (sum, item) => sum + item.price_mad * item.quantity,
      0
    );
    const shipping = subtotal > 300 ? 0 : 30;
    const total = subtotal + shipping;
    document.getElementById("cartSubtotal").textContent =
      this.formatPrice(subtotal);
    document.getElementById("shippingCost").textContent =
      this.formatPrice(shipping);
    document.getElementById("cartTotal").textContent = this.formatPrice(total);
    const checkoutSummary = document.getElementById("checkoutSummary");
    if (checkoutSummary) {
      checkoutSummary.innerHTML = `${this.cart
        .map(
          (item) =>
            `<div class="checkout-item">${item.name} Ã— ${
              item.quantity
            } - ${this.formatPrice(item.price_mad * item.quantity)}</div>`
        )
        .join("")}<div class="checkout-total">Total: ${this.formatPrice(
        total
      )}</div>`;
    }
  }
  updateCartCount() {
    const countElement = document.getElementById("cartCount");
    if (countElement) {
      const totalItems = this.cart.reduce(
        (sum, item) => sum + item.quantity,
        0
      );
      countElement.textContent = totalItems;
      countElement.style.display = totalItems > 0 ? "flex" : "none";
    }
  }
  async showProductDetail(productId) {
    const product = this.products.find((p) => p.id === productId);
    if (!product) return;
    const modalBody = document.getElementById("productModalBody");
    modalBody.innerHTML = `<div class="product-detail"><img src="${
      product.image
    }" alt="${
      product.name
    }" class="product-detail-image"><div class="product-detail-info"><h2>${
      product.name
    }</h2><div class="product-detail-price">${this.formatPrice(
      product.price_mad
    )}</div><div class="product-weight">${
      product.weight
    }</div><p class="product-detail-description">${product.long_desc}</p>${
      product.ingredients
        ? `<div class="product-detail-ingredients"><h4>Ingredients</h4><p>${product.ingredients.join(
            ", "
          )}</p></div>`
        : ""
    }${
      product.is_organic
        ? '<div class="organic-badge">ðŸŒ¿ Certified Organic</div>'
        : ""
    }<div class="product-actions" style="margin-top: 2rem;"><button class="btn btn-primary" onclick="store.addToCart(${this.escapeProduct(
      product
    )}); store.closeProductModal()">Add to Cart</button><button class="btn btn-secondary" onclick="store.closeProductModal()">Continue Shopping</button></div></div></div>`;
    this.showModal("productModal");
  }
  closeProductModal() {
    this.hideModal("productModal");
  }
  openCheckout() {
    if (this.cart.length === 0) {
      this.showNotification("Your cart is empty");
      return;
    }
    this.showModal("checkoutModal");
  }
  closeCheckout() {
    this.hideModal("checkoutModal");
  }
  async handleCheckout(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const orderData = {
      customer: {
        name: formData.get("name"),
        email: formData.get("email"),
        phone: formData.get("phone"),
        address: formData.get("address"),
        notes: formData.get("notes"),
      },
      items: this.cart,
      total: this.cart.reduce(
        (sum, item) => sum + item.price_mad * item.quantity,
        0
      ),
      order_reference: "TB" + Date.now(),
      timestamp: new Date().toISOString(),
    };
    console.log("Order placed:", orderData);
    document.getElementById("orderReference").textContent =
      orderData.order_reference;
    this.hideModal("checkoutModal");
    this.showModal("successModal");
    this.clearCart();
  }
  openWhatsApp() {
    const message =
      this.cart.length > 0
        ? this.generateOrderMessage()
        : "Hello! I'm interested in Tadla Bio products. Can you tell me more?";
    const phoneNumber = "+212 633-076440";
    const url = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(
      message
    )}`;
    window.open(url, "_blank");
  }
  generateOrderMessage() {
    const items = this.cart
      .map(
        (item) =>
          `â€¢ ${item.name} (${item.weight}) Ã— ${
            item.quantity
          } - ${this.formatPrice(item.price_mad * item.quantity)}`
      )
      .join("\n");
    const total = this.cart.reduce(
      (sum, item) => sum + item.price_mad * item.quantity,
      0
    );
    return `Hello Tadla Bio! I'd like to place an order:\n\n${items}\n\nTotal: ${this.formatPrice(
      total
    )}\n\nPlease contact me to confirm and arrange delivery.`;
  }
  handleNewsletter(event) {
    event.preventDefault();
    const email = event.target.querySelector('input[type="email"]').value;
    console.log("Newsletter subscription:", email);
    this.showNotification("Thank you for subscribing!");
    event.target.reset();
  }
  formatPrice(price) {
    return new Intl.NumberFormat("fr-MA", {
      style: "currency",
      currency: "MAD",
    }).format(price);
  }
  escapeProduct(product) {
    return JSON.stringify(product).replace(/"/g, "&quot;");
  }
  showNotification(message) {
    const notification = document.createElement("div");
    notification.style.cssText = `position: fixed;top: 100px;right: 20px;background: var(--color-olive);color: white;padding: 1rem 1.5rem;border-radius: var(--radius);box-shadow: var(--shadow-lg);z-index: 5000;transform: translateX(400px);transition: transform 0.3s ease;`;
    notification.textContent = message;
    document.body.appendChild(notification);
    setTimeout(() => (notification.style.transform = "translateX(0)"), 100);
    setTimeout(() => {
      notification.style.transform = "translateX(400px)";
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }
  showModal(modalId) {
    document.getElementById(modalId).classList.add("active");
    document.body.style.overflow = "hidden";
  }
  hideModal(modalId) {
    document.getElementById(modalId).classList.remove("active");
    document.body.style.overflow = "auto";
  }
  closeSuccessModal() {
    this.hideModal("successModal");
  }
  setupEventListeners() {
    document.querySelectorAll(".filter-btn").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        document
          .querySelectorAll(".filter-btn")
          .forEach((b) => b.classList.remove("active"));
        e.target.classList.add("active");
        this.filter = e.target.dataset.filter;
        this.renderProducts();
      });
    });
    document
      .querySelectorAll(".product-modal, .checkout-modal, .success-modal")
      .forEach((modal) => {
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            this.hideModal(modal.id);
          }
        });
      });
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        this.hideModal("productModal");
        this.hideModal("checkoutModal");
        this.hideModal("successModal");
      }
    });
  }
}
let store;
function toggleCart() {
  const cart = document.getElementById("cartDrawer");
  cart.classList.toggle("active");
}
function toggleMobileMenu() {
  const menu = document.getElementById("mobileMenu");
  menu.classList.toggle("active");
}
function scrollToProducts() {
  document.getElementById("products").scrollIntoView({ behavior: "smooth" });
}
function openWhatsApp() {
  store.openWhatsApp();
}
function openCheckout() {
  store.openCheckout();
}
function closeCheckout() {
  store.closeCheckout();
}
function closeSuccessModal() {
  store.closeSuccessModal();
}
function handleCheckout(event) {
  store.handleCheckout(event);
}
function handleNewsletter(event) {
  store.handleNewsletter(event);
}
document.addEventListener("DOMContentLoaded", () => {
  store = new TadlaBioStore();
});
